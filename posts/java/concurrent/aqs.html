<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.37" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://vuepress-theme-hope-v2-demo.mrhope.site/posts/java/concurrent/aqs.html"><meta property="og:site_name" content="Technology Blog"><meta property="og:title" content="AQS åŸç†ä»¥åŠ AQS åŒæ­¥ç»„ä»¶æ€»ç»“"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="article:tag" content="Javaå¹¶å‘"><link rel="stylesheet" href="//at.alicdn.com/t/font_2410206_mfj6e1vbwo.css"><title>AQS åŸç†ä»¥åŠ AQS åŒæ­¥ç»„ä»¶æ€»ç»“ | Technology Blog</title><meta name="description" content="Technology Blog">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background-color: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="stylesheet" href="/assets/style.5f1f4424.css">
    <link rel="modulepreload" href="/assets/app.2fa2f6d2.js"><link rel="modulepreload" href="/assets/aqs.html.f60cc4d1.js"><link rel="modulepreload" href="/assets/aqs.html.ce36316f.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to content</a><!--]--><div class="theme-container has-toc sidebar-open"><!--[--><header class="navbar"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><a href="/" class="home-link"><img class="logo" src="/logo.svg" alt="Technology Blog"><!----><span class="site-name hide-in-pad">Technology Blog</span><!--[--><!----><!--]--></a><nav class="nav-links" style=""><div class="nav-item hide-in-mobile"><a href="/home.html" class="nav-link" arialabel="æŠ€æœ¯æŒ‡å—"><i class="icon iconfont icon-creative"></i>æŠ€æœ¯æŒ‡å—<!----></a></div></nav><div class="nav-actions-wrapper"><!--[--><!----><!--]--><div class="nav-item"><!----></div><div class="nav-item"><a class="repo-link" href="https://github.com/vuepress-theme-hope/vuepress-theme-hope" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewbox="0 0 1024 1024" arialabelledby="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><title id="github" lang="en">github icon</title><g fill="currentColor"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></g></svg></a></div><div class="nav-item hide-in-mobile"><button class="outlook-button" tabindex="-1" ariahidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewbox="0 0 1024 1024" arialabelledby="outlook"><title id="outlook" lang="en">outlook icon</title><g fill="currentColor"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></g></svg><div class="outlook-dropdown"><!----></div></button></div><form class="search-box" role="search"><input type="search" placeholder="æœç´¢" autocomplete="off" spellcheck="false" value><!----></form><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button><!--[--><!----><!--]--></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable active"><i class="icon iconfont icon-java"></i><span class="title">Java</span><span class="arrow down"></span></button><!--[--><!--[--><ul class="sidebar-links"><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><i class="icon iconfont icon-basic"></i><span class="title">åŸºç¡€</span><span class="arrow right"></span></button><!--[--><!--[--><!----><!--]--><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><i class="icon iconfont icon-container"></i><span class="title">å®¹å™¨</span><span class="arrow right"></span></button><!--[--><!--[--><!----><!--]--><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable active"><i class="icon iconfont icon-et-performance"></i><span class="title">å¹¶å‘ç¼–ç¨‹</span><span class="arrow down"></span></button><!--[--><!--[--><ul class="sidebar-links"><li><!--[--><a href="/posts/java/concurrent/java-concurrent-questions-01.html" class="nav-link sidebar-link sidebar-page" arialabel="Java å¹¶å‘å¸¸è§çŸ¥è¯†ç‚¹&amp;é¢è¯•é¢˜æ€»ç»“ï¼ˆåŸºç¡€ç¯‡ï¼‰"><!---->Java å¹¶å‘å¸¸è§çŸ¥è¯†ç‚¹&amp;é¢è¯•é¢˜æ€»ç»“ï¼ˆåŸºç¡€ç¯‡ï¼‰<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/posts/java/concurrent/java-concurrent-questions-02.html" class="nav-link sidebar-link sidebar-page" arialabel="Java å¹¶å‘å¸¸è§çŸ¥è¯†ç‚¹&amp;é¢è¯•é¢˜æ€»ç»“ï¼ˆè¿›é˜¶ç¯‡ï¼‰"><!---->Java å¹¶å‘å¸¸è§çŸ¥è¯†ç‚¹&amp;é¢è¯•é¢˜æ€»ç»“ï¼ˆè¿›é˜¶ç¯‡ï¼‰<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable active"><i class="icon iconfont icon-important"></i><span class="title">é‡è¦çŸ¥è¯†ç‚¹</span><span class="arrow down"></span></button><!--[--><!--[--><ul class="sidebar-links"><li><!--[--><a href="/posts/java/concurrent/java-thread-pool-summary.html" class="nav-link sidebar-link sidebar-page" arialabel="Java çº¿ç¨‹æ± è¯¦è§£"><!---->Java çº¿ç¨‹æ± è¯¦è§£<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/posts/java/concurrent/java-thread-pool-best-practices.html" class="nav-link sidebar-link sidebar-page" arialabel="Java çº¿ç¨‹æ± æœ€ä½³å®è·µ"><!---->Java çº¿ç¨‹æ± æœ€ä½³å®è·µ<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/posts/java/concurrent/java-concurrent-collections.html" class="nav-link sidebar-link sidebar-page" arialabel="Java å¸¸è§å¹¶å‘å®¹å™¨æ€»ç»“"><!---->Java å¸¸è§å¹¶å‘å®¹å™¨æ€»ç»“<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/posts/java/concurrent/aqs.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" arialabel="AQS åŸç†ä»¥åŠ AQS åŒæ­¥ç»„ä»¶æ€»ç»“"><!---->AQS åŸç†ä»¥åŠ AQS åŒæ­¥ç»„ä»¶æ€»ç»“<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/posts/java/concurrent/aqs.html#aqs-ç®€å•ä»‹ç»" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="AQS ç®€å•ä»‹ç»"><!---->AQS ç®€å•ä»‹ç»<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/posts/java/concurrent/aqs.html#aqs-åŸç†" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="AQS åŸç†"><!---->AQS åŸç†<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/posts/java/concurrent/aqs.html#aqs-åŸç†æ¦‚è§ˆ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="AQS åŸç†æ¦‚è§ˆ"><!---->AQS åŸç†æ¦‚è§ˆ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/posts/java/concurrent/aqs.html#aqs-å¯¹èµ„æºçš„å…±äº«æ–¹å¼" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="AQS å¯¹èµ„æºçš„å…±äº«æ–¹å¼"><!---->AQS å¯¹èµ„æºçš„å…±äº«æ–¹å¼<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/posts/java/concurrent/aqs.html#aqs-åº•å±‚ä½¿ç”¨äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="AQS åº•å±‚ä½¿ç”¨äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼"><!---->AQS åº•å±‚ä½¿ç”¨äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/posts/java/concurrent/aqs.html#semaphore-ä¿¡å·é‡" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="Semaphore(ä¿¡å·é‡)"><!---->Semaphore(ä¿¡å·é‡)<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/posts/java/concurrent/aqs.html#countdownlatch-å€’è®¡æ—¶å™¨" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="CountDownLatch ï¼ˆå€’è®¡æ—¶å™¨ï¼‰"><!---->CountDownLatch ï¼ˆå€’è®¡æ—¶å™¨ï¼‰<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/posts/java/concurrent/aqs.html#countdownlatch-çš„ä¸¤ç§å…¸å‹ç”¨æ³•" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="CountDownLatch çš„ä¸¤ç§å…¸å‹ç”¨æ³•"><!---->CountDownLatch çš„ä¸¤ç§å…¸å‹ç”¨æ³•<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/posts/java/concurrent/aqs.html#countdownlatch-çš„ä½¿ç”¨ç¤ºä¾‹" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="CountDownLatch çš„ä½¿ç”¨ç¤ºä¾‹"><!---->CountDownLatch çš„ä½¿ç”¨ç¤ºä¾‹<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/posts/java/concurrent/aqs.html#countdownlatch-çš„ä¸è¶³" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="CountDownLatch çš„ä¸è¶³"><!---->CountDownLatch çš„ä¸è¶³<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/posts/java/concurrent/aqs.html#countdownlatch-ç›¸å¸¸è§é¢è¯•é¢˜" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="CountDownLatch ç›¸å¸¸è§é¢è¯•é¢˜"><!---->CountDownLatch ç›¸å¸¸è§é¢è¯•é¢˜<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/posts/java/concurrent/aqs.html#cyclicbarrier-å¾ªç¯æ …æ " class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="CyclicBarrier(å¾ªç¯æ …æ )"><!---->CyclicBarrier(å¾ªç¯æ …æ )<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/posts/java/concurrent/aqs.html#cyclicbarrier-çš„åº”ç”¨åœºæ™¯" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="CyclicBarrier çš„åº”ç”¨åœºæ™¯"><!---->CyclicBarrier çš„åº”ç”¨åœºæ™¯<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/posts/java/concurrent/aqs.html#cyclicbarrier-çš„ä½¿ç”¨ç¤ºä¾‹" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="CyclicBarrier çš„ä½¿ç”¨ç¤ºä¾‹"><!---->CyclicBarrier çš„ä½¿ç”¨ç¤ºä¾‹<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/posts/java/concurrent/aqs.html#cyclicbarrier-æºç åˆ†æ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="CyclicBarrier æºç åˆ†æ"><!---->CyclicBarrier æºç åˆ†æ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/posts/java/concurrent/aqs.html#cyclicbarrier-å’Œ-countdownlatch-çš„åŒºåˆ«" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="CyclicBarrier å’Œ CountDownLatch çš„åŒºåˆ«"><!---->CyclicBarrier å’Œ CountDownLatch çš„åŒºåˆ«<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/posts/java/concurrent/aqs.html#reentrantlock-å’Œ-reentrantreadwritelock" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="ReentrantLock å’Œ ReentrantReadWriteLock"><!---->ReentrantLock å’Œ ReentrantReadWriteLock<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li><li><!--[--><a href="/posts/java/concurrent/reentrantlock.html" class="nav-link sidebar-link sidebar-page" arialabel="ä»ReentrantLockçš„å®ç°çœ‹AQSçš„åŸç†åŠåº”ç”¨"><!---->ä»ReentrantLockçš„å®ç°çœ‹AQSçš„åŸç†åŠåº”ç”¨<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/posts/java/concurrent/atomic-classes.html" class="nav-link sidebar-link sidebar-page" arialabel="Atomic åŸå­ç±»æ€»ç»“"><!---->Atomic åŸå­ç±»æ€»ç»“<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/posts/java/concurrent/threadlocal.html" class="nav-link sidebar-link sidebar-page" arialabel="ä¸‡å­—è§£æ ThreadLocal å…³é”®å­—"><!---->ä¸‡å­—è§£æ ThreadLocal å…³é”®å­—<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/posts/java/concurrent/completablefuture-intro.html" class="nav-link sidebar-link sidebar-page" arialabel="CompletableFutureå…¥é—¨"><!---->CompletableFutureå…¥é—¨<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul><!--]--><!----><!--]--></section><!--]--></li></ul><!--]--><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><i class="icon iconfont icon-virtual_machine"></i><span class="title">JVM</span><span class="arrow right"></span></button><!--[--><!--[--><!----><!--]--><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><i class="icon iconfont icon-features"></i><span class="title">æ–°ç‰¹æ€§</span><span class="arrow right"></span></button><!--[--><!--[--><!----><!--]--><!----><!--]--></section><!--]--></li></ul><!--]--><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><i class="icon iconfont icon-computer"></i><span class="title">è®¡ç®—æœºåŸºç¡€</span><span class="arrow right"></span></button><!--[--><!--[--><!----><!--]--><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><i class="icon iconfont icon-database"></i><span class="title">æ•°æ®åº“</span><span class="arrow right"></span></button><!--[--><!--[--><!----><!--]--><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><i class="icon iconfont icon-Tools"></i><span class="title">å¼€å‘å·¥å…·</span><span class="arrow right"></span></button><!--[--><!--[--><!----><!--]--><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><i class="icon iconfont icon-xitongsheji"></i><span class="title">ç³»ç»Ÿè®¾è®¡</span><span class="arrow right"></span></button><!--[--><!--[--><!----><!--]--><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><i class="icon iconfont icon-distributed-network"></i><span class="title">åˆ†å¸ƒå¼</span><span class="arrow right"></span></button><!--[--><!--[--><!----><!--]--><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><i class="icon iconfont icon-et-performance"></i><span class="title">é«˜æ€§èƒ½</span><span class="arrow right"></span></button><!--[--><!--[--><!----><!--]--><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><i class="icon iconfont icon-CalendarAvailability-1"></i><span class="title">é«˜å¯ç”¨</span><span class="arrow right"></span></button><!--[--><!--[--><!----><!--]--><!----><!--]--></section><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->AQS åŸç†ä»¥åŠ AQS åŒæ­¥ç»„ä»¶æ€»ç»“</h1><div class="article-info"><!----><span class="date-info" arialabel="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down" isoriginal="false" pageview="false" color="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewbox="0 0 1024 1024" arialabelledby="calendar"><title id="calendar" lang="en">calendar icon</title><g fill="currentColor"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></g></svg><span>2022å¹´4æœˆ3æ—¥</span><meta property="datePublished" content="2022-04-02T16:39:30.000Z"></span><span class="category-info" arialabel="åˆ†ç±»ğŸŒˆ" data-balloon-pos="down" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewbox="0 0 1024 1024" arialabelledby="category"><title id="category" lang="en">category icon</title><g fill="currentColor"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></g></svg><ul class="categories-wrapper"><li class="category category4 clickable" role="navigation">Java</li><meta property="articleSection" content="Java"></ul></span><span arialabel="æ ‡ç­¾ğŸ·" data-balloon-pos="down" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewbox="0 0 1024 1024" arialabelledby="tag"><title id="tag" lang="en">tag icon</title><g fill="currentColor"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></g></svg><ul class="tags-wrapper"><li class="tag tag8 clickable" role="navigation">Javaå¹¶å‘</li></ul><meta property="keywords" content="Javaå¹¶å‘"></span><span class="reading-time-info" arialabel="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down" isoriginal="false" pageview="false" color="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewbox="0 0 1024 1024" arialabelledby="timer"><title id="timer" lang="en">timer icon</title><g fill="currentColor"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></g></svg><span>å¤§çº¦ 21 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT21M"></span></div><hr></div><div class="toc-place-holder"><aside id="toc-list"><div class="toc-header">æ­¤é¡µå†…å®¹</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/posts/java/concurrent/aqs.html#aqs-ç®€å•ä»‹ç»" class="router-link-active router-link-exact-active toc-link level2">AQS ç®€å•ä»‹ç»</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/java/concurrent/aqs.html#aqs-åŸç†" class="router-link-active router-link-exact-active toc-link level2">AQS åŸç†</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/posts/java/concurrent/aqs.html#aqs-åŸç†æ¦‚è§ˆ" class="router-link-active router-link-exact-active toc-link level3">AQS åŸç†æ¦‚è§ˆ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/java/concurrent/aqs.html#aqs-å¯¹èµ„æºçš„å…±äº«æ–¹å¼" class="router-link-active router-link-exact-active toc-link level3">AQS å¯¹èµ„æºçš„å…±äº«æ–¹å¼</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/java/concurrent/aqs.html#aqs-åº•å±‚ä½¿ç”¨äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼" class="router-link-active router-link-exact-active toc-link level3">AQS åº•å±‚ä½¿ç”¨äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/java/concurrent/aqs.html#semaphore-ä¿¡å·é‡" class="router-link-active router-link-exact-active toc-link level2">Semaphore(ä¿¡å·é‡)</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/java/concurrent/aqs.html#countdownlatch-å€’è®¡æ—¶å™¨" class="router-link-active router-link-exact-active toc-link level2">CountDownLatch ï¼ˆå€’è®¡æ—¶å™¨ï¼‰</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/posts/java/concurrent/aqs.html#countdownlatch-çš„ä¸¤ç§å…¸å‹ç”¨æ³•" class="router-link-active router-link-exact-active toc-link level3">CountDownLatch çš„ä¸¤ç§å…¸å‹ç”¨æ³•</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/java/concurrent/aqs.html#countdownlatch-çš„ä½¿ç”¨ç¤ºä¾‹" class="router-link-active router-link-exact-active toc-link level3">CountDownLatch çš„ä½¿ç”¨ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/java/concurrent/aqs.html#countdownlatch-çš„ä¸è¶³" class="router-link-active router-link-exact-active toc-link level3">CountDownLatch çš„ä¸è¶³</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/java/concurrent/aqs.html#countdownlatch-ç›¸å¸¸è§é¢è¯•é¢˜" class="router-link-active router-link-exact-active toc-link level3">CountDownLatch ç›¸å¸¸è§é¢è¯•é¢˜</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/java/concurrent/aqs.html#cyclicbarrier-å¾ªç¯æ …æ " class="router-link-active router-link-exact-active toc-link level2">CyclicBarrier(å¾ªç¯æ …æ )</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/posts/java/concurrent/aqs.html#cyclicbarrier-çš„åº”ç”¨åœºæ™¯" class="router-link-active router-link-exact-active toc-link level3">CyclicBarrier çš„åº”ç”¨åœºæ™¯</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/java/concurrent/aqs.html#cyclicbarrier-çš„ä½¿ç”¨ç¤ºä¾‹" class="router-link-active router-link-exact-active toc-link level3">CyclicBarrier çš„ä½¿ç”¨ç¤ºä¾‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/java/concurrent/aqs.html#cyclicbarrier-æºç åˆ†æ" class="router-link-active router-link-exact-active toc-link level3">CyclicBarrier æºç åˆ†æ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/java/concurrent/aqs.html#cyclicbarrier-å’Œ-countdownlatch-çš„åŒºåˆ«" class="router-link-active router-link-exact-active toc-link level3">CyclicBarrier å’Œ CountDownLatch çš„åŒºåˆ«</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/java/concurrent/aqs.html#reentrantlock-å’Œ-reentrantreadwritelock" class="router-link-active router-link-exact-active toc-link level3">ReentrantLock å’Œ ReentrantReadWriteLock</a></li><!----><!--]--></ul><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><!--[--><p>å¼€å§‹ä¹‹å‰ï¼Œå…ˆæ¥çœ‹å‡ é“å¸¸è§çš„é¢è¯•é¢˜ï¼å»ºè®®ä½ å¸¦ç€è¿™äº›é—®é¢˜æ¥çœ‹è¿™ç¯‡æ–‡ç« ï¼š</p><ul><li>ä½•ä¸º AQSï¼ŸAQS åŸç†äº†è§£å—ï¼Ÿ</li><li><code>CountDownLatch</code> å’Œ <code>CyclicBarrier</code> äº†è§£å—ï¼Ÿä¸¤è€…çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>ç”¨è¿‡ <code>Semaphore</code> å—ï¼Ÿåº”ç”¨åœºæ™¯äº†è§£å—ï¼Ÿ</li><li>......</li></ul><h2 id="aqs-ç®€å•ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#aqs-ç®€å•ä»‹ç»" aria-hidden="true">#</a> AQS ç®€å•ä»‹ç»</h2><p>AQS çš„å…¨ç§°ä¸º <code>AbstractQueuedSynchronizer</code> ï¼Œç¿»è¯‘è¿‡æ¥çš„æ„æ€å°±æ˜¯æŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨ã€‚è¿™ä¸ªç±»åœ¨ <code>java.util.concurrent.locks</code> åŒ…ä¸‹é¢ã€‚</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/Java ç¨‹åºå‘˜å¿…å¤‡ï¼šå¹¶å‘çŸ¥è¯†ç³»ç»Ÿæ€»ç»“/AQS.png" alt="enter image description here" loading="lazy"></p><p>AQS å°±æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œä¸»è¦ç”¨æ¥æ„å»ºé”å’ŒåŒæ­¥å™¨ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractQueuedSynchronizer</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractOwnableSynchronizer</span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>AQS ä¸ºæ„å»ºé”å’ŒåŒæ­¥å™¨æä¾›äº†ä¸€äº›é€šç”¨åŠŸèƒ½çš„æ˜¯å®ç°ï¼Œå› æ­¤ï¼Œä½¿ç”¨ AQS èƒ½ç®€å•ä¸”é«˜æ•ˆåœ°æ„é€ å‡ºåº”ç”¨å¹¿æ³›çš„å¤§é‡çš„åŒæ­¥å™¨ï¼Œæ¯”å¦‚æˆ‘ä»¬æåˆ°çš„ <code>ReentrantLock</code>ï¼Œ<code>Semaphore</code>ï¼Œå…¶ä»–çš„è¯¸å¦‚ <code>ReentrantReadWriteLock</code>ï¼Œ<code>SynchronousQueue</code>ï¼Œ<code>FutureTask</code>(jdk1.7) ç­‰ç­‰çš†æ˜¯åŸºäº AQS çš„ã€‚</p><h2 id="aqs-åŸç†" tabindex="-1"><a class="header-anchor" href="#aqs-åŸç†" aria-hidden="true">#</a> AQS åŸç†</h2><blockquote><p>åœ¨é¢è¯•ä¸­è¢«é—®åˆ°å¹¶å‘çŸ¥è¯†çš„æ—¶å€™ï¼Œå¤§å¤šéƒ½ä¼šè¢«é—®åˆ°â€œè¯·ä½ è¯´ä¸€ä¸‹è‡ªå·±å¯¹äº AQS åŸç†çš„ç†è§£â€ã€‚ä¸‹é¢ç»™å¤§å®¶ä¸€ä¸ªç¤ºä¾‹ä¾›å¤§å®¶å‚è€ƒï¼Œé¢è¯•ä¸æ˜¯èƒŒé¢˜ï¼Œå¤§å®¶ä¸€å®šè¦åŠ å…¥è‡ªå·±çš„æ€æƒ³ï¼Œå³ä½¿åŠ å…¥ä¸äº†è‡ªå·±çš„æ€æƒ³ä¹Ÿè¦ä¿è¯è‡ªå·±èƒ½å¤Ÿé€šä¿—çš„è®²å‡ºæ¥è€Œä¸æ˜¯èƒŒå‡ºæ¥ã€‚</p></blockquote><p>ä¸‹é¢å¤§éƒ¨åˆ†å†…å®¹å…¶å®åœ¨ AQS ç±»æ³¨é‡Šä¸Šå·²ç»ç»™å‡ºäº†ï¼Œä¸è¿‡æ˜¯è‹±è¯­çœ‹ç€æ¯”è¾ƒåƒåŠ›ä¸€ç‚¹ï¼Œæ„Ÿå…´è¶£çš„è¯å¯ä»¥çœ‹çœ‹æºç ã€‚</p><h3 id="aqs-åŸç†æ¦‚è§ˆ" tabindex="-1"><a class="header-anchor" href="#aqs-åŸç†æ¦‚è§ˆ" aria-hidden="true">#</a> AQS åŸç†æ¦‚è§ˆ</h3><p>AQS æ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œå¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºç©ºé—²ï¼Œåˆ™å°†å½“å‰è¯·æ±‚èµ„æºçš„çº¿ç¨‹è®¾ç½®ä¸ºæœ‰æ•ˆçš„å·¥ä½œçº¿ç¨‹ï¼Œå¹¶ä¸”å°†å…±äº«èµ„æºè®¾ç½®ä¸ºé”å®šçŠ¶æ€ã€‚å¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºè¢«å ç”¨ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸€å¥—çº¿ç¨‹é˜»å¡ç­‰å¾…ä»¥åŠè¢«å”¤é†’æ—¶é”åˆ†é…çš„æœºåˆ¶ï¼Œè¿™ä¸ªæœºåˆ¶ AQS æ˜¯ç”¨ <strong>CLH é˜Ÿåˆ—é”</strong>å®ç°çš„ï¼Œå³å°†æš‚æ—¶è·å–ä¸åˆ°é”çš„çº¿ç¨‹åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚</p><blockquote><p>CLH(Craig,Landin,and Hagersten)é˜Ÿåˆ—æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„åŒå‘é˜Ÿåˆ—ï¼ˆè™šæ‹Ÿçš„åŒå‘é˜Ÿåˆ—å³ä¸å­˜åœ¨é˜Ÿåˆ—å®ä¾‹ï¼Œä»…å­˜åœ¨ç»“ç‚¹ä¹‹é—´çš„å…³è”å…³ç³»ï¼‰ã€‚AQS æ˜¯å°†æ¯æ¡è¯·æ±‚å…±äº«èµ„æºçš„çº¿ç¨‹å°è£…æˆä¸€ä¸ª CLH é”é˜Ÿåˆ—çš„ä¸€ä¸ªç»“ç‚¹ï¼ˆNodeï¼‰æ¥å®ç°é”çš„åˆ†é…ã€‚</p></blockquote><p>çœ‹ä¸ª AQS(<code>AbstractQueuedSynchronizer</code>)åŸç†å›¾ï¼š</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/Java ç¨‹åºå‘˜å¿…å¤‡ï¼šå¹¶å‘çŸ¥è¯†ç³»ç»Ÿæ€»ç»“/CLH.png" alt="enter image description here" loading="lazy"></p><p>AQS ä½¿ç”¨ä¸€ä¸ª int æˆå‘˜å˜é‡æ¥è¡¨ç¤ºåŒæ­¥çŠ¶æ€ï¼Œé€šè¿‡å†…ç½®çš„ FIFO é˜Ÿåˆ—æ¥å®Œæˆè·å–èµ„æºçº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œã€‚AQS ä½¿ç”¨ CAS å¯¹è¯¥åŒæ­¥çŠ¶æ€è¿›è¡ŒåŸå­æ“ä½œå®ç°å¯¹å…¶å€¼çš„ä¿®æ”¹ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> state<span class="token punctuation">;</span><span class="token comment">//å…±äº«å˜é‡ï¼Œä½¿ç”¨volatileä¿®é¥°ä¿è¯çº¿ç¨‹å¯è§æ€§</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>çŠ¶æ€ä¿¡æ¯é€šè¿‡ <code>protected</code> ç±»å‹çš„<code>getState()</code>ï¼Œ<code>setState()</code>ï¼Œ<code>compareAndSetState()</code> è¿›è¡Œæ“ä½œ</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//è¿”å›åŒæ­¥çŠ¶æ€çš„å½“å‰å€¼</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> state<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 <span class="token comment">// è®¾ç½®åŒæ­¥çŠ¶æ€çš„å€¼</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">setState</span><span class="token punctuation">(</span><span class="token keyword">int</span> newState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        state <span class="token operator">=</span> newState<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//åŸå­åœ°ï¼ˆCASæ“ä½œï¼‰å°†åŒæ­¥çŠ¶æ€å€¼è®¾ç½®ä¸ºç»™å®šå€¼updateå¦‚æœå½“å‰åŒæ­¥çŠ¶æ€çš„å€¼ç­‰äºexpectï¼ˆæœŸæœ›å€¼ï¼‰</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token keyword">int</span> expect<span class="token punctuation">,</span> <span class="token keyword">int</span> update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> unsafe<span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> stateOffset<span class="token punctuation">,</span> expect<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="aqs-å¯¹èµ„æºçš„å…±äº«æ–¹å¼" tabindex="-1"><a class="header-anchor" href="#aqs-å¯¹èµ„æºçš„å…±äº«æ–¹å¼" aria-hidden="true">#</a> AQS å¯¹èµ„æºçš„å…±äº«æ–¹å¼</h3><p>AQS å®šä¹‰ä¸¤ç§èµ„æºå…±äº«æ–¹å¼</p><p><strong>1)Exclusive</strong>ï¼ˆç‹¬å ï¼‰</p><p>åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ‰§è¡Œï¼Œå¦‚ <code>ReentrantLock</code>ã€‚åˆå¯åˆ†ä¸ºå…¬å¹³é”å’Œéå…¬å¹³é”ï¼Œ<code>ReentrantLock</code> åŒæ—¶æ”¯æŒä¸¤ç§é”ï¼Œä¸‹é¢ä»¥ <code>ReentrantLock</code> å¯¹è¿™ä¸¤ç§é”çš„å®šä¹‰åšä»‹ç»ï¼š</p><ul><li><strong>å…¬å¹³é”</strong> ï¼šæŒ‰ç…§çº¿ç¨‹åœ¨é˜Ÿåˆ—ä¸­çš„æ’é˜Ÿé¡ºåºï¼Œå…ˆåˆ°è€…å…ˆæ‹¿åˆ°é”</li><li><strong>éå…¬å¹³é”</strong> ï¼šå½“çº¿ç¨‹è¦è·å–é”æ—¶ï¼Œå…ˆé€šè¿‡ä¸¤æ¬¡ CAS æ“ä½œå»æŠ¢é”ï¼Œå¦‚æœæ²¡æŠ¢åˆ°ï¼Œå½“å‰çº¿ç¨‹å†åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ç­‰å¾…å”¤é†’ã€‚</li></ul><blockquote><p>è¯´æ˜ï¼šä¸‹é¢è¿™éƒ¨åˆ†å…³äº <code>ReentrantLock</code> æºä»£ç å†…å®¹èŠ‚é€‰è‡ªï¼šhttps://www.javadoop.com/post/AbstractQueuedSynchronizer-2 ï¼Œè¿™æ˜¯ä¸€ç¯‡å¾ˆä¸é”™æ–‡ç« ï¼Œæ¨èé˜…è¯»ã€‚</p></blockquote><p><strong>ä¸‹é¢æ¥çœ‹ <code>ReentrantLock</code> ä¸­ç›¸å…³çš„æºä»£ç ï¼š</strong></p><p><code>ReentrantLock</code> é»˜è®¤é‡‡ç”¨éå…¬å¹³é”ï¼Œå› ä¸ºè€ƒè™‘è·å¾—æ›´å¥½çš„æ€§èƒ½ï¼Œé€šè¿‡ <code>boolean</code> æ¥å†³å®šæ˜¯å¦ç”¨å…¬å¹³é”ï¼ˆä¼ å…¥ true ç”¨å…¬å¹³é”ï¼‰ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/** Synchronizer providing all implementation mechanics */</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Sync</span> sync<span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// é»˜è®¤éå…¬å¹³é”</span>
    sync <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fair<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sync <span class="token operator">=</span> fair <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">FairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><code>ReentrantLock</code> ä¸­å…¬å¹³é”çš„ <code>lock</code> æ–¹æ³•</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">FairSync</span> <span class="token keyword">extends</span> <span class="token class-name">Sync</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// AbstractQueuedSynchronizer.acquire(int arg)</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">.</span>EXCLUSIVE<span class="token punctuation">)</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">selfInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 1. å’Œéå…¬å¹³é”ç›¸æ¯”ï¼Œè¿™é‡Œå¤šäº†ä¸€ä¸ªåˆ¤æ–­ï¼šæ˜¯å¦æœ‰çº¿ç¨‹åœ¨ç­‰å¾…</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasQueuedPredecessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> acquires<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> nextc <span class="token operator">=</span> c <span class="token operator">+</span> acquires<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nextc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Maximum lock count exceeded&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setState</span><span class="token punctuation">(</span>nextc<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>éå…¬å¹³é”çš„ <code>lock</code> æ–¹æ³•ï¼š</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">NonfairSync</span> <span class="token keyword">extends</span> <span class="token class-name">Sync</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 2. å’Œå…¬å¹³é”ç›¸æ¯”ï¼Œè¿™é‡Œä¼šç›´æ¥å…ˆè¿›è¡Œä¸€æ¬¡CASï¼ŒæˆåŠŸå°±è¿”å›äº†</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// AbstractQueuedSynchronizer.acquire(int arg)</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">.</span>EXCLUSIVE<span class="token punctuation">)</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">selfInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">nonfairTryAcquire</span><span class="token punctuation">(</span>acquires<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token doc-comment comment">/**
 * Performs non-fair tryLock.  tryAcquire is implemented in
 * subclasses, but both need nonfair try for trylock method.
 */</span>
<span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">nonfairTryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è¿™é‡Œæ²¡æœ‰å¯¹é˜»å¡é˜Ÿåˆ—è¿›è¡Œåˆ¤æ–­</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> acquires<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> nextc <span class="token operator">=</span> c <span class="token operator">+</span> acquires<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// overflow</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Maximum lock count exceeded&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setState</span><span class="token punctuation">(</span>nextc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>æ€»ç»“ï¼šå…¬å¹³é”å’Œéå…¬å¹³é”åªæœ‰ä¸¤å¤„ä¸åŒï¼š</p><ol><li>éå…¬å¹³é”åœ¨è°ƒç”¨ lock åï¼Œé¦–å…ˆå°±ä¼šè°ƒç”¨ CAS è¿›è¡Œä¸€æ¬¡æŠ¢é”ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™æ°å·§é”æ²¡æœ‰è¢«å ç”¨ï¼Œé‚£ä¹ˆç›´æ¥å°±è·å–åˆ°é”è¿”å›äº†ã€‚</li><li>éå…¬å¹³é”åœ¨ CAS å¤±è´¥åï¼Œå’Œå…¬å¹³é”ä¸€æ ·éƒ½ä¼šè¿›å…¥åˆ° <code>tryAcquire</code> æ–¹æ³•ï¼Œåœ¨ <code>tryAcquire</code> æ–¹æ³•ä¸­ï¼Œå¦‚æœå‘ç°é”è¿™ä¸ªæ—¶å€™è¢«é‡Šæ”¾äº†ï¼ˆstate == 0ï¼‰ï¼Œéå…¬å¹³é”ä¼šç›´æ¥ CAS æŠ¢é”ï¼Œä½†æ˜¯å…¬å¹³é”ä¼šåˆ¤æ–­ç­‰å¾…é˜Ÿåˆ—æ˜¯å¦æœ‰çº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€ï¼Œå¦‚æœæœ‰åˆ™ä¸å»æŠ¢é”ï¼Œä¹–ä¹–æ’åˆ°åé¢ã€‚</li></ol><p>å…¬å¹³é”å’Œéå…¬å¹³é”å°±è¿™ä¸¤ç‚¹åŒºåˆ«ï¼Œå¦‚æœè¿™ä¸¤æ¬¡ CAS éƒ½ä¸æˆåŠŸï¼Œé‚£ä¹ˆåé¢éå…¬å¹³é”å’Œå…¬å¹³é”æ˜¯ä¸€æ ·çš„ï¼Œéƒ½è¦è¿›å…¥åˆ°é˜»å¡é˜Ÿåˆ—ç­‰å¾…å”¤é†’ã€‚</p><p>ç›¸å¯¹æ¥è¯´ï¼Œéå…¬å¹³é”ä¼šæœ‰æ›´å¥½çš„æ€§èƒ½ï¼Œå› ä¸ºå®ƒçš„ååé‡æ¯”è¾ƒå¤§ã€‚å½“ç„¶ï¼Œéå…¬å¹³é”è®©è·å–é”çš„æ—¶é—´å˜å¾—æ›´åŠ ä¸ç¡®å®šï¼Œå¯èƒ½ä¼šå¯¼è‡´åœ¨é˜»å¡é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹é•¿æœŸå¤„äºé¥¥é¥¿çŠ¶æ€ã€‚</p><p><strong>2)Share</strong>ï¼ˆå…±äº«ï¼‰</p><p>å¤šä¸ªçº¿ç¨‹å¯åŒæ—¶æ‰§è¡Œï¼Œå¦‚ <code>Semaphore/CountDownLatch</code>ã€‚<code>Semaphore</code>ã€<code>CountDownLatch</code>ã€ <code>CyclicBarrier</code>ã€<code>ReadWriteLock</code> æˆ‘ä»¬éƒ½ä¼šåœ¨åé¢è®²åˆ°ã€‚</p><p><code>ReentrantReadWriteLock</code> å¯ä»¥çœ‹æˆæ˜¯ç»„åˆå¼ï¼Œå› ä¸º <code>ReentrantReadWriteLock</code> ä¹Ÿå°±æ˜¯è¯»å†™é”å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶å¯¹æŸä¸€èµ„æºè¿›è¡Œè¯»ã€‚</p><p>ä¸åŒçš„è‡ªå®šä¹‰åŒæ­¥å™¨äº‰ç”¨å…±äº«èµ„æºçš„æ–¹å¼ä¹Ÿä¸åŒã€‚è‡ªå®šä¹‰åŒæ­¥å™¨åœ¨å®ç°æ—¶åªéœ€è¦å®ç°å…±äº«èµ„æº state çš„è·å–ä¸é‡Šæ”¾æ–¹å¼å³å¯ï¼Œè‡³äºå…·ä½“çº¿ç¨‹ç­‰å¾…é˜Ÿåˆ—çš„ç»´æŠ¤ï¼ˆå¦‚è·å–èµ„æºå¤±è´¥å…¥é˜Ÿ/å”¤é†’å‡ºé˜Ÿç­‰ï¼‰ï¼ŒAQS å·²ç»åœ¨ä¸Šå±‚å·²ç»å¸®æˆ‘ä»¬å®ç°å¥½äº†ã€‚</p><h3 id="aqs-åº•å±‚ä½¿ç”¨äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#aqs-åº•å±‚ä½¿ç”¨äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼" aria-hidden="true">#</a> AQS åº•å±‚ä½¿ç”¨äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼</h3><p>åŒæ­¥å™¨çš„è®¾è®¡æ˜¯åŸºäºæ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„ï¼Œå¦‚æœéœ€è¦è‡ªå®šä¹‰åŒæ­¥å™¨ä¸€èˆ¬çš„æ–¹å¼æ˜¯è¿™æ ·ï¼ˆæ¨¡æ¿æ–¹æ³•æ¨¡å¼å¾ˆç»å…¸çš„ä¸€ä¸ªåº”ç”¨ï¼‰ï¼š</p><ol><li>ä½¿ç”¨è€…ç»§æ‰¿ <code>AbstractQueuedSynchronizer</code> å¹¶é‡å†™æŒ‡å®šçš„æ–¹æ³•ã€‚ï¼ˆè¿™äº›é‡å†™æ–¹æ³•å¾ˆç®€å•ï¼Œæ— éæ˜¯å¯¹äºå…±äº«èµ„æº state çš„è·å–å’Œé‡Šæ”¾ï¼‰</li><li>å°† AQS ç»„åˆåœ¨è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶çš„å®ç°ä¸­ï¼Œå¹¶è°ƒç”¨å…¶æ¨¡æ¿æ–¹æ³•ï¼Œè€Œè¿™äº›æ¨¡æ¿æ–¹æ³•ä¼šè°ƒç”¨ä½¿ç”¨è€…é‡å†™çš„æ–¹æ³•ã€‚</li></ol><p>è¿™å’Œæˆ‘ä»¬ä»¥å¾€é€šè¿‡å®ç°æ¥å£çš„æ–¹å¼æœ‰å¾ˆå¤§åŒºåˆ«ï¼Œè¿™æ˜¯æ¨¡æ¿æ–¹æ³•æ¨¡å¼å¾ˆç»å…¸çš„ä¸€ä¸ªè¿ç”¨ã€‚</p><p><strong>AQS ä½¿ç”¨äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Œè‡ªå®šä¹‰åŒæ­¥å™¨æ—¶éœ€è¦é‡å†™ä¸‹é¢å‡ ä¸ª AQS æä¾›çš„é’©å­æ–¹æ³•ï¼š</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token comment">//ç‹¬å æ–¹å¼ã€‚å°è¯•è·å–èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›falseã€‚</span>
<span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryRelease</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token comment">//ç‹¬å æ–¹å¼ã€‚å°è¯•é‡Šæ”¾èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›falseã€‚</span>
<span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token comment">//å…±äº«æ–¹å¼ã€‚å°è¯•è·å–èµ„æºã€‚è´Ÿæ•°è¡¨ç¤ºå¤±è´¥ï¼›0è¡¨ç¤ºæˆåŠŸï¼Œä½†æ²¡æœ‰å‰©ä½™å¯ç”¨èµ„æºï¼›æ­£æ•°è¡¨ç¤ºæˆåŠŸï¼Œä¸”æœ‰å‰©ä½™èµ„æºã€‚</span>
<span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryReleaseShared</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token comment">//å…±äº«æ–¹å¼ã€‚å°è¯•é‡Šæ”¾èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›falseã€‚</span>
<span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isHeldExclusively</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//è¯¥çº¿ç¨‹æ˜¯å¦æ­£åœ¨ç‹¬å èµ„æºã€‚åªæœ‰ç”¨åˆ°conditionæ‰éœ€è¦å»å®ç°å®ƒã€‚</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>ä»€ä¹ˆæ˜¯é’©å­æ–¹æ³•å‘¢ï¼Ÿ</strong> é’©å­æ–¹æ³•æ˜¯ä¸€ç§è¢«å£°æ˜åœ¨æŠ½è±¡ç±»ä¸­çš„æ–¹æ³•ï¼Œä¸€èˆ¬ä½¿ç”¨ <code>protected</code> å…³é”®å­—ä¿®é¥°ï¼Œå®ƒå¯ä»¥æ˜¯ç©ºæ–¹æ³•ï¼ˆç”±å­ç±»å®ç°ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯é»˜è®¤å®ç°çš„æ–¹æ³•ã€‚æ¨¡æ¿è®¾è®¡æ¨¡å¼é€šè¿‡é’©å­æ–¹æ³•æ§åˆ¶å›ºå®šæ­¥éª¤çš„å®ç°ã€‚</p><p>ç¯‡å¹…é—®é¢˜ï¼Œè¿™é‡Œå°±ä¸è¯¦ç»†ä»‹ç»æ¨¡æ¿æ–¹æ³•æ¨¡å¼äº†ï¼Œä¸å¤ªäº†è§£çš„å°ä¼™ä¼´å¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç« ï¼š<a href="https://mp.weixin.qq.com/s/zpScSCktFpnSWHWIQem2jg" target="_blank" rel="noopener noreferrer">ç”¨Java8 æ”¹é€ åçš„æ¨¡æ¿æ–¹æ³•æ¨¡å¼çœŸçš„æ˜¯ yyds!<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ã€‚</p><p>é™¤äº†ä¸Šé¢æåˆ°çš„é’©å­æ–¹æ³•ä¹‹å¤–ï¼ŒAQS ç±»ä¸­çš„å…¶ä»–æ–¹æ³•éƒ½æ˜¯ <code>final</code> ï¼Œæ‰€ä»¥æ— æ³•è¢«å…¶ä»–ç±»é‡å†™ã€‚</p><p>ä»¥ <code>ReentrantLock</code> ä¸ºä¾‹ï¼Œstate åˆå§‹åŒ–ä¸º 0ï¼Œè¡¨ç¤ºæœªé”å®šçŠ¶æ€ã€‚A çº¿ç¨‹ <code>lock()</code> æ—¶ï¼Œä¼šè°ƒç”¨ <code>tryAcquire()</code> ç‹¬å è¯¥é”å¹¶å°† <code>state+1</code> ã€‚æ­¤åï¼Œå…¶ä»–çº¿ç¨‹å† <code>tryAcquire()</code> æ—¶å°±ä¼šå¤±è´¥ï¼Œç›´åˆ° A çº¿ç¨‹ <code>unlock()</code> åˆ° <code>state=</code>0ï¼ˆå³é‡Šæ”¾é”ï¼‰ä¸ºæ­¢ï¼Œå…¶å®ƒçº¿ç¨‹æ‰æœ‰æœºä¼šè·å–è¯¥é”ã€‚å½“ç„¶ï¼Œé‡Šæ”¾é”ä¹‹å‰ï¼ŒA çº¿ç¨‹è‡ªå·±æ˜¯å¯ä»¥é‡å¤è·å–æ­¤é”çš„ï¼ˆstate ä¼šç´¯åŠ ï¼‰ï¼Œè¿™å°±æ˜¯å¯é‡å…¥çš„æ¦‚å¿µã€‚ä½†è¦æ³¨æ„ï¼Œè·å–å¤šå°‘æ¬¡å°±è¦é‡Šæ”¾å¤šå°‘æ¬¡ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯ state æ˜¯èƒ½å›åˆ°é›¶æ€çš„ã€‚</p><p>å†ä»¥ <code>CountDownLatch</code> ä»¥ä¾‹ï¼Œä»»åŠ¡åˆ†ä¸º N ä¸ªå­çº¿ç¨‹å»æ‰§è¡Œï¼Œstate ä¹Ÿåˆå§‹åŒ–ä¸º Nï¼ˆæ³¨æ„ N è¦ä¸çº¿ç¨‹ä¸ªæ•°ä¸€è‡´ï¼‰ã€‚è¿™ N ä¸ªå­çº¿ç¨‹æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼Œæ¯ä¸ªå­çº¿ç¨‹æ‰§è¡Œå®Œå<code> countDown()</code> ä¸€æ¬¡ï¼Œstate ä¼š CAS(Compare and Swap) å‡ 1ã€‚ç­‰åˆ°æ‰€æœ‰å­çº¿ç¨‹éƒ½æ‰§è¡Œå®Œå(å³ <code>state=0</code> )ï¼Œä¼š <code>unpark()</code> ä¸»è°ƒç”¨çº¿ç¨‹ï¼Œç„¶åä¸»è°ƒç”¨çº¿ç¨‹å°±ä¼šä» <code>await()</code> å‡½æ•°è¿”å›ï¼Œç»§ç»­åä½™åŠ¨ä½œã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œè‡ªå®šä¹‰åŒæ­¥å™¨è¦ä¹ˆæ˜¯ç‹¬å æ–¹æ³•ï¼Œè¦ä¹ˆæ˜¯å…±äº«æ–¹å¼ï¼Œä»–ä»¬ä¹Ÿåªéœ€å®ç°<code>tryAcquire-tryRelease</code>ã€<code>tryAcquireShared-tryReleaseShared</code>ä¸­çš„ä¸€ç§å³å¯ã€‚ä½† AQS ä¹Ÿæ”¯æŒè‡ªå®šä¹‰åŒæ­¥å™¨åŒæ—¶å®ç°ç‹¬å å’Œå…±äº«ä¸¤ç§æ–¹å¼ï¼Œå¦‚<code>ReentrantReadWriteLock</code>ã€‚</p><p>æ¨èä¸¤ç¯‡ AQS åŸç†å’Œç›¸å…³æºç åˆ†æçš„æ–‡ç« ï¼š</p><ul><li><a href="https://www.cnblogs.com/waterystone/p/4920797.html" target="_blank" rel="noopener noreferrer">Javaå¹¶å‘ä¹‹AQSè¯¦è§£<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://www.cnblogs.com/chengxiao/p/7141160.html" target="_blank" rel="noopener noreferrer">Javaå¹¶å‘åŒ…åŸºçŸ³-AQSè¯¦è§£<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><h2 id="semaphore-ä¿¡å·é‡" tabindex="-1"><a class="header-anchor" href="#semaphore-ä¿¡å·é‡" aria-hidden="true">#</a> Semaphore(ä¿¡å·é‡)</h2><p><code>synchronized</code> å’Œ <code>ReentrantLock</code> éƒ½æ˜¯ä¸€æ¬¡åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è®¿é—®æŸä¸ªèµ„æºï¼Œ<code>Semaphore</code>(ä¿¡å·é‡)å¯ä»¥æŒ‡å®šå¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®æŸä¸ªèµ„æºã€‚</p><p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 *
 * <span class="token keyword">@author</span> Snailclimb
 * <span class="token keyword">@date</span> 2018å¹´9æœˆ30æ—¥
 * @Description: éœ€è¦ä¸€æ¬¡æ€§æ‹¿ä¸€ä¸ªè®¸å¯çš„æƒ…å†µ
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SemaphoreExample1</span> <span class="token punctuation">{</span>
  <span class="token comment">// è¯·æ±‚çš„æ•°é‡</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> threadCount <span class="token operator">=</span> <span class="token number">550</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ›å»ºä¸€ä¸ªå…·æœ‰å›ºå®šçº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± å¯¹è±¡ï¼ˆå¦‚æœè¿™é‡Œçº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡ç»™å¤ªå°‘çš„è¯ä½ ä¼šå‘ç°æ‰§è¡Œçš„å¾ˆæ…¢ï¼‰</span>
    <span class="token class-name">ExecutorService</span> threadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ä¸€æ¬¡åªèƒ½å…è®¸æ‰§è¡Œçš„çº¿ç¨‹æ•°é‡ã€‚</span>
    <span class="token keyword">final</span> <span class="token class-name">Semaphore</span> semaphore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> threadCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">final</span> <span class="token keyword">int</span> threadnum <span class="token operator">=</span> i<span class="token punctuation">;</span>
      threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span><span class="token comment">// Lambda è¡¨è¾¾å¼çš„è¿ç”¨</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          semaphore<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// è·å–ä¸€ä¸ªè®¸å¯ï¼Œæ‰€ä»¥å¯è¿è¡Œçº¿ç¨‹æ•°é‡ä¸º20/1=20</span>
          <span class="token function">test</span><span class="token punctuation">(</span>threadnum<span class="token punctuation">)</span><span class="token punctuation">;</span>
          semaphore<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// é‡Šæ”¾ä¸€ä¸ªè®¸å¯</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// TODO Auto-generated catch block</span>
          e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    threadPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;finish&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">int</span> threadnum<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æ¨¡æ‹Ÿè¯·æ±‚çš„è€—æ—¶æ“ä½œ</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;threadnum:&quot;</span> <span class="token operator">+</span> threadnum<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æ¨¡æ‹Ÿè¯·æ±‚çš„è€—æ—¶æ“ä½œ</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>æ‰§è¡Œ <code>acquire()</code> æ–¹æ³•é˜»å¡ï¼Œç›´åˆ°æœ‰ä¸€ä¸ªè®¸å¯è¯å¯ä»¥è·å¾—ç„¶åæ‹¿èµ°ä¸€ä¸ªè®¸å¯è¯ï¼›æ¯ä¸ª <code>release</code> æ–¹æ³•å¢åŠ ä¸€ä¸ªè®¸å¯è¯ï¼Œè¿™å¯èƒ½ä¼šé‡Šæ”¾ä¸€ä¸ªé˜»å¡çš„ <code>acquire()</code> æ–¹æ³•ã€‚ç„¶è€Œï¼Œå…¶å®å¹¶æ²¡æœ‰å®é™…çš„è®¸å¯è¯è¿™ä¸ªå¯¹è±¡ï¼Œ<code>Semaphore</code> åªæ˜¯ç»´æŒäº†ä¸€ä¸ªå¯è·å¾—è®¸å¯è¯çš„æ•°é‡ã€‚ <code>Semaphore</code> ç»å¸¸ç”¨äºé™åˆ¶è·å–æŸç§èµ„æºçš„çº¿ç¨‹æ•°é‡ã€‚</p><p>å½“ç„¶ä¸€æ¬¡ä¹Ÿå¯ä»¥ä¸€æ¬¡æ‹¿å–å’Œé‡Šæ”¾å¤šä¸ªè®¸å¯ï¼Œä¸è¿‡ä¸€èˆ¬æ²¡æœ‰å¿…è¦è¿™æ ·åšï¼š</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>semaphore<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// è·å–5ä¸ªè®¸å¯ï¼Œæ‰€ä»¥å¯è¿è¡Œçº¿ç¨‹æ•°é‡ä¸º20/5=4</span>
<span class="token function">test</span><span class="token punctuation">(</span>threadnum<span class="token punctuation">)</span><span class="token punctuation">;</span>
semaphore<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// é‡Šæ”¾5ä¸ªè®¸å¯</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>é™¤äº† <code>acquire()</code> æ–¹æ³•ä¹‹å¤–ï¼Œå¦ä¸€ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„ä¸ä¹‹å¯¹åº”çš„æ–¹æ³•æ˜¯ <code>tryAcquire()</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¦‚æœè·å–ä¸åˆ°è®¸å¯å°±ç«‹å³è¿”å› falseã€‚</p><p><code>Semaphore</code> æœ‰ä¸¤ç§æ¨¡å¼ï¼Œå…¬å¹³æ¨¡å¼å’Œéå…¬å¹³æ¨¡å¼ã€‚</p><ul><li><strong>å…¬å¹³æ¨¡å¼ï¼š</strong> è°ƒç”¨ <code>acquire()</code> æ–¹æ³•çš„é¡ºåºå°±æ˜¯è·å–è®¸å¯è¯çš„é¡ºåºï¼Œéµå¾ª FIFOï¼›</li><li><strong>éå…¬å¹³æ¨¡å¼ï¼š</strong> æŠ¢å å¼çš„ã€‚</li></ul><p><code>Semaphore</code> å¯¹åº”çš„ä¸¤ä¸ªæ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>   <span class="token keyword">public</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token keyword">permits</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sync <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token keyword">permits</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token keyword">permits</span><span class="token punctuation">,</span> <span class="token keyword">boolean</span> fair<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sync <span class="token operator">=</span> fair <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">FairSync</span><span class="token punctuation">(</span><span class="token keyword">permits</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token keyword">permits</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>è¿™ä¸¤ä¸ªæ„é€ æ–¹æ³•ï¼Œéƒ½å¿…é¡»æä¾›è®¸å¯çš„æ•°é‡ï¼Œç¬¬äºŒä¸ªæ„é€ æ–¹æ³•å¯ä»¥æŒ‡å®šæ˜¯å…¬å¹³æ¨¡å¼è¿˜æ˜¯éå…¬å¹³æ¨¡å¼ï¼Œé»˜è®¤éå…¬å¹³æ¨¡å¼ã€‚</strong></p><p><a href="https://github.com/Snailclimb/JavaGuide/issues/645" target="_blank" rel="noopener noreferrer">issue645 è¡¥å……å†…å®¹<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ï¼š<code>Semaphore</code> ä¸ <code>CountDownLatch</code> ä¸€æ ·ï¼Œä¹Ÿæ˜¯å…±äº«é”çš„ä¸€ç§å®ç°ã€‚å®ƒé»˜è®¤æ„é€  AQS çš„ state ä¸º <code>permits</code>ã€‚å½“æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ•°é‡è¶…å‡º <code>permits</code>ï¼Œé‚£ä¹ˆå¤šä½™çš„çº¿ç¨‹å°†ä¼šè¢«æ”¾å…¥é˜»å¡é˜Ÿåˆ— Park,å¹¶è‡ªæ—‹åˆ¤æ–­ state æ˜¯å¦å¤§äº 0ã€‚åªæœ‰å½“ state å¤§äº 0 çš„æ—¶å€™ï¼Œé˜»å¡çš„çº¿ç¨‹æ‰èƒ½ç»§ç»­æ‰§è¡Œ,æ­¤æ—¶å…ˆå‰æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ç»§ç»­æ‰§è¡Œ <code>release()</code> æ–¹æ³•ï¼Œ<code>release()</code> æ–¹æ³•ä½¿å¾— state çš„å˜é‡ä¼šåŠ  1ï¼Œé‚£ä¹ˆè‡ªæ—‹çš„çº¿ç¨‹ä¾¿ä¼šåˆ¤æ–­æˆåŠŸã€‚ å¦‚æ­¤ï¼Œæ¯æ¬¡åªæœ‰æœ€å¤šä¸è¶…è¿‡ <code>permits</code> æ•°é‡çš„çº¿ç¨‹èƒ½è‡ªæ—‹æˆåŠŸï¼Œä¾¿é™åˆ¶äº†æ‰§è¡Œä»»åŠ¡çº¿ç¨‹çš„æ•°é‡ã€‚</p><h2 id="countdownlatch-å€’è®¡æ—¶å™¨" tabindex="-1"><a class="header-anchor" href="#countdownlatch-å€’è®¡æ—¶å™¨" aria-hidden="true">#</a> CountDownLatch ï¼ˆå€’è®¡æ—¶å™¨ï¼‰</h2><p><code>CountDownLatch</code> å…è®¸ <code>count</code> ä¸ªçº¿ç¨‹é˜»å¡åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œç›´è‡³æ‰€æœ‰çº¿ç¨‹çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•ã€‚</p><p><code>CountDownLatch</code> æ˜¯å…±äº«é”çš„ä¸€ç§å®ç°,å®ƒé»˜è®¤æ„é€  AQS çš„ <code>state</code> å€¼ä¸º <code>count</code>ã€‚å½“çº¿ç¨‹ä½¿ç”¨ <code>countDown()</code> æ–¹æ³•æ—¶,å…¶å®ä½¿ç”¨äº†<code>tryReleaseShared</code>æ–¹æ³•ä»¥ CAS çš„æ“ä½œæ¥å‡å°‘ <code>state</code>,ç›´è‡³ <code>state</code> ä¸º 0 ã€‚å½“è°ƒç”¨ <code>await()</code> æ–¹æ³•çš„æ—¶å€™ï¼Œå¦‚æœ <code>state</code> ä¸ä¸º 0ï¼Œé‚£å°±è¯æ˜ä»»åŠ¡è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œ<code>await()</code> æ–¹æ³•å°±ä¼šä¸€ç›´é˜»å¡ï¼Œä¹Ÿå°±æ˜¯è¯´ <code>await()</code> æ–¹æ³•ä¹‹åçš„è¯­å¥ä¸ä¼šè¢«æ‰§è¡Œã€‚ç„¶åï¼Œ<code>CountDownLatch</code> ä¼šè‡ªæ—‹ CAS åˆ¤æ–­ <code>state == 0</code>ï¼Œå¦‚æœ <code>state == 0</code> çš„è¯ï¼Œå°±ä¼šé‡Šæ”¾æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ï¼Œ<code>await()</code> æ–¹æ³•ä¹‹åçš„è¯­å¥å¾—åˆ°æ‰§è¡Œã€‚</p><h3 id="countdownlatch-çš„ä¸¤ç§å…¸å‹ç”¨æ³•" tabindex="-1"><a class="header-anchor" href="#countdownlatch-çš„ä¸¤ç§å…¸å‹ç”¨æ³•" aria-hidden="true">#</a> CountDownLatch çš„ä¸¤ç§å…¸å‹ç”¨æ³•</h3><p><strong>1ã€æŸä¸€çº¿ç¨‹åœ¨å¼€å§‹è¿è¡Œå‰ç­‰å¾… n ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæ¯•ã€‚</strong></p><p>å°† <code>CountDownLatch</code> çš„è®¡æ•°å™¨åˆå§‹åŒ–ä¸º n ï¼ˆ<code>new CountDownLatch(n)</code>ï¼‰ï¼Œæ¯å½“ä¸€ä¸ªä»»åŠ¡çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œå°±å°†è®¡æ•°å™¨å‡ 1 ï¼ˆ<code>countdownlatch.countDown()</code>ï¼‰ï¼Œå½“è®¡æ•°å™¨çš„å€¼å˜ä¸º 0 æ—¶ï¼Œåœ¨ <code>CountDownLatch ä¸Š await()</code> çš„çº¿ç¨‹å°±ä¼šè¢«å”¤é†’ã€‚ä¸€ä¸ªå…¸å‹åº”ç”¨åœºæ™¯å°±æ˜¯å¯åŠ¨ä¸€ä¸ªæœåŠ¡æ—¶ï¼Œä¸»çº¿ç¨‹éœ€è¦ç­‰å¾…å¤šä¸ªç»„ä»¶åŠ è½½å®Œæ¯•ï¼Œä¹‹åå†ç»§ç»­æ‰§è¡Œã€‚</p><p><strong>2ã€å®ç°å¤šä¸ªçº¿ç¨‹å¼€å§‹æ‰§è¡Œä»»åŠ¡çš„æœ€å¤§å¹¶è¡Œæ€§ã€‚</strong></p><p>æ³¨æ„æ˜¯å¹¶è¡Œæ€§ï¼Œä¸æ˜¯å¹¶å‘ï¼Œå¼ºè°ƒçš„æ˜¯å¤šä¸ªçº¿ç¨‹åœ¨æŸä¸€æ—¶åˆ»åŒæ—¶å¼€å§‹æ‰§è¡Œã€‚ç±»ä¼¼äºèµ›è·‘ï¼Œå°†å¤šä¸ªçº¿ç¨‹æ”¾åˆ°èµ·ç‚¹ï¼Œç­‰å¾…å‘ä»¤æªå“ï¼Œç„¶ååŒæ—¶å¼€è·‘ã€‚åšæ³•æ˜¯åˆå§‹åŒ–ä¸€ä¸ªå…±äº«çš„ <code>CountDownLatch</code> å¯¹è±¡ï¼Œå°†å…¶è®¡æ•°å™¨åˆå§‹åŒ–ä¸º 1 ï¼ˆ<code>new CountDownLatch(1)</code>ï¼‰ï¼Œå¤šä¸ªçº¿ç¨‹åœ¨å¼€å§‹æ‰§è¡Œä»»åŠ¡å‰é¦–å…ˆ <code>coundownlatch.await()</code>ï¼Œå½“ä¸»çº¿ç¨‹è°ƒç”¨ <code>countDown()</code> æ—¶ï¼Œè®¡æ•°å™¨å˜ä¸º 0ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶è¢«å”¤é†’ã€‚</p><h3 id="countdownlatch-çš„ä½¿ç”¨ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#countdownlatch-çš„ä½¿ç”¨ç¤ºä¾‹" aria-hidden="true">#</a> CountDownLatch çš„ä½¿ç”¨ç¤ºä¾‹</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 *
 * <span class="token keyword">@author</span> SnailClimb
 * <span class="token keyword">@date</span> 2018å¹´10æœˆ1æ—¥
 * @Description: CountDownLatch ä½¿ç”¨æ–¹æ³•ç¤ºä¾‹
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CountDownLatchExample1</span> <span class="token punctuation">{</span>
  <span class="token comment">// è¯·æ±‚çš„æ•°é‡</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> threadCount <span class="token operator">=</span> <span class="token number">550</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ›å»ºä¸€ä¸ªå…·æœ‰å›ºå®šçº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± å¯¹è±¡ï¼ˆå¦‚æœè¿™é‡Œçº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡ç»™å¤ªå°‘çš„è¯ä½ ä¼šå‘ç°æ‰§è¡Œçš„å¾ˆæ…¢ï¼‰</span>
    <span class="token class-name">ExecutorService</span> threadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">CountDownLatch</span> countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span>threadCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> threadCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">final</span> <span class="token keyword">int</span> threadnum <span class="token operator">=</span> i<span class="token punctuation">;</span>
      threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span><span class="token comment">// Lambda è¡¨è¾¾å¼çš„è¿ç”¨</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token function">test</span><span class="token punctuation">(</span>threadnum<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// TODO Auto-generated catch block</span>
          e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
          countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// è¡¨ç¤ºä¸€ä¸ªè¯·æ±‚å·²ç»è¢«å®Œæˆ</span>
        <span class="token punctuation">}</span>

      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    threadPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;finish&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">int</span> threadnum<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æ¨¡æ‹Ÿè¯·æ±‚çš„è€—æ—¶æ“ä½œ</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;threadnum:&quot;</span> <span class="token operator">+</span> threadnum<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æ¨¡æ‹Ÿè¯·æ±‚çš„è€—æ—¶æ“ä½œ</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†è¯·æ±‚çš„æ•°é‡ä¸º 550ï¼Œå½“è¿™ 550 ä¸ªè¯·æ±‚è¢«å¤„ç†å®Œæˆä¹‹åï¼Œæ‰ä¼šæ‰§è¡Œ<code>System.out.println(&quot;finish&quot;);</code>ã€‚</p><p>ä¸ <code>CountDownLatch</code> çš„ç¬¬ä¸€æ¬¡äº¤äº’æ˜¯ä¸»çº¿ç¨‹ç­‰å¾…å…¶ä»–çº¿ç¨‹ã€‚ä¸»çº¿ç¨‹å¿…é¡»åœ¨å¯åŠ¨å…¶ä»–çº¿ç¨‹åç«‹å³è°ƒç”¨ <code>CountDownLatch.await()</code> æ–¹æ³•ã€‚è¿™æ ·ä¸»çº¿ç¨‹çš„æ“ä½œå°±ä¼šåœ¨è¿™ä¸ªæ–¹æ³•ä¸Šé˜»å¡ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹å®Œæˆå„è‡ªçš„ä»»åŠ¡ã€‚</p><p>å…¶ä»– N ä¸ªçº¿ç¨‹å¿…é¡»å¼•ç”¨é—­é”å¯¹è±¡ï¼Œå› ä¸ºä»–ä»¬éœ€è¦é€šçŸ¥ <code>CountDownLatch</code> å¯¹è±¡ï¼Œä»–ä»¬å·²ç»å®Œæˆäº†å„è‡ªçš„ä»»åŠ¡ã€‚è¿™ç§é€šçŸ¥æœºåˆ¶æ˜¯é€šè¿‡ <code>CountDownLatch.countDown()</code>æ–¹æ³•æ¥å®Œæˆçš„ï¼›æ¯è°ƒç”¨ä¸€æ¬¡è¿™ä¸ªæ–¹æ³•ï¼Œåœ¨æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–çš„ count å€¼å°±å‡ 1ã€‚æ‰€ä»¥å½“ N ä¸ªçº¿ç¨‹éƒ½è°ƒ ç”¨äº†è¿™ä¸ªæ–¹æ³•ï¼Œcount çš„å€¼ç­‰äº 0ï¼Œç„¶åä¸»çº¿ç¨‹å°±èƒ½é€šè¿‡ <code>await()</code>æ–¹æ³•ï¼Œæ¢å¤æ‰§è¡Œè‡ªå·±çš„ä»»åŠ¡ã€‚</p><p>å†æ’ä¸€å˜´ï¼š<code>CountDownLatch</code> çš„ <code>await()</code> æ–¹æ³•ä½¿ç”¨ä¸å½“å¾ˆå®¹æ˜“äº§ç”Ÿæ­»é”ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¸Šé¢ä»£ç ä¸­çš„ for å¾ªç¯æ”¹ä¸ºï¼š</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> threadCount<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>è¿™æ ·å°±å¯¼è‡´ <code>count</code> çš„å€¼æ²¡åŠæ³•ç­‰äº 0ï¼Œç„¶åå°±ä¼šå¯¼è‡´ä¸€ç›´ç­‰å¾…ã€‚</p><h3 id="countdownlatch-çš„ä¸è¶³" tabindex="-1"><a class="header-anchor" href="#countdownlatch-çš„ä¸è¶³" aria-hidden="true">#</a> CountDownLatch çš„ä¸è¶³</h3><p><code>CountDownLatch</code> æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œè®¡æ•°å™¨çš„å€¼åªèƒ½åœ¨æ„é€ æ–¹æ³•ä¸­åˆå§‹åŒ–ä¸€æ¬¡ï¼Œä¹‹åæ²¡æœ‰ä»»ä½•æœºåˆ¶å†æ¬¡å¯¹å…¶è®¾ç½®å€¼ï¼Œå½“ <code>CountDownLatch</code> ä½¿ç”¨å®Œæ¯•åï¼Œå®ƒä¸èƒ½å†æ¬¡è¢«ä½¿ç”¨ã€‚</p><h3 id="countdownlatch-ç›¸å¸¸è§é¢è¯•é¢˜" tabindex="-1"><a class="header-anchor" href="#countdownlatch-ç›¸å¸¸è§é¢è¯•é¢˜" aria-hidden="true">#</a> CountDownLatch ç›¸å¸¸è§é¢è¯•é¢˜</h3><ul><li><code>CountDownLatch</code> æ€ä¹ˆç”¨ï¼Ÿåº”ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ</li><li><code>CountDownLatch</code> å’Œ <code>CyclicBarrier</code> çš„ä¸åŒä¹‹å¤„ï¼Ÿ</li><li><code>CountDownLatch</code> ç±»ä¸­ä¸»è¦çš„æ–¹æ³•ï¼Ÿ</li></ul><h2 id="cyclicbarrier-å¾ªç¯æ …æ " tabindex="-1"><a class="header-anchor" href="#cyclicbarrier-å¾ªç¯æ …æ " aria-hidden="true">#</a> CyclicBarrier(å¾ªç¯æ …æ )</h2><p><code>CyclicBarrier</code> å’Œ <code>CountDownLatch</code> éå¸¸ç±»ä¼¼ï¼Œå®ƒä¹Ÿå¯ä»¥å®ç°çº¿ç¨‹é—´çš„æŠ€æœ¯ç­‰å¾…ï¼Œä½†æ˜¯å®ƒçš„åŠŸèƒ½æ¯” <code>CountDownLatch</code> æ›´åŠ å¤æ‚å’Œå¼ºå¤§ã€‚ä¸»è¦åº”ç”¨åœºæ™¯å’Œ <code>CountDownLatch</code> ç±»ä¼¼ã€‚</p><blockquote><p><code>CountDownLatch</code> çš„å®ç°æ˜¯åŸºäº AQS çš„ï¼Œè€Œ <code>CycliBarrier</code> æ˜¯åŸºäº <code>ReentrantLock</code>(<code>ReentrantLock</code> ä¹Ÿå±äº AQS åŒæ­¥å™¨)å’Œ <code>Condition</code> çš„ã€‚</p></blockquote><p><code>CyclicBarrier</code> çš„å­—é¢æ„æ€æ˜¯å¯å¾ªç¯ä½¿ç”¨ï¼ˆCyclicï¼‰çš„å±éšœï¼ˆBarrierï¼‰ã€‚å®ƒè¦åšçš„äº‹æƒ…æ˜¯ï¼šè®©ä¸€ç»„çº¿ç¨‹åˆ°è¾¾ä¸€ä¸ªå±éšœï¼ˆä¹Ÿå¯ä»¥å«åŒæ­¥ç‚¹ï¼‰æ—¶è¢«é˜»å¡ï¼Œç›´åˆ°æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœæ—¶ï¼Œå±éšœæ‰ä¼šå¼€é—¨ï¼Œæ‰€æœ‰è¢«å±éšœæ‹¦æˆªçš„çº¿ç¨‹æ‰ä¼šç»§ç»­å¹²æ´»ã€‚</p><p><code>CyclicBarrier</code> é»˜è®¤çš„æ„é€ æ–¹æ³•æ˜¯ <code>CyclicBarrier(int parties)</code>ï¼Œå…¶å‚æ•°è¡¨ç¤ºå±éšœæ‹¦æˆªçš„çº¿ç¨‹æ•°é‡ï¼Œæ¯ä¸ªçº¿ç¨‹è°ƒç”¨ <code>await()</code> æ–¹æ³•å‘Šè¯‰ <code>CyclicBarrier</code> æˆ‘å·²ç»åˆ°è¾¾äº†å±éšœï¼Œç„¶åå½“å‰çº¿ç¨‹è¢«é˜»å¡ã€‚</p><p>å†æ¥çœ‹ä¸€ä¸‹å®ƒçš„æ„é€ å‡½æ•°ï¼š</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">CyclicBarrier</span><span class="token punctuation">(</span><span class="token keyword">int</span> parties<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span>parties<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">CyclicBarrier</span><span class="token punctuation">(</span><span class="token keyword">int</span> parties<span class="token punctuation">,</span> <span class="token class-name">Runnable</span> barrierAction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parties <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>parties <span class="token operator">=</span> parties<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> parties<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>barrierCommand <span class="token operator">=</span> barrierAction<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>å…¶ä¸­ï¼Œparties å°±ä»£è¡¨äº†æœ‰æ‹¦æˆªçš„çº¿ç¨‹çš„æ•°é‡ï¼Œå½“æ‹¦æˆªçš„çº¿ç¨‹æ•°é‡è¾¾åˆ°è¿™ä¸ªå€¼çš„æ—¶å€™å°±æ‰“å¼€æ …æ ï¼Œè®©æ‰€æœ‰çº¿ç¨‹é€šè¿‡ã€‚</p><h3 id="cyclicbarrier-çš„åº”ç”¨åœºæ™¯" tabindex="-1"><a class="header-anchor" href="#cyclicbarrier-çš„åº”ç”¨åœºæ™¯" aria-hidden="true">#</a> CyclicBarrier çš„åº”ç”¨åœºæ™¯</h3><p><code>CyclicBarrier</code> å¯ä»¥ç”¨äºå¤šçº¿ç¨‹è®¡ç®—æ•°æ®ï¼Œæœ€ååˆå¹¶è®¡ç®—ç»“æœçš„åº”ç”¨åœºæ™¯ã€‚æ¯”å¦‚æˆ‘ä»¬ç”¨ä¸€ä¸ª Excel ä¿å­˜äº†ç”¨æˆ·æ‰€æœ‰é“¶è¡Œæµæ°´ï¼Œæ¯ä¸ª Sheet ä¿å­˜ä¸€ä¸ªå¸æˆ·è¿‘ä¸€å¹´çš„æ¯ç¬”é“¶è¡Œæµæ°´ï¼Œç°åœ¨éœ€è¦ç»Ÿè®¡ç”¨æˆ·çš„æ—¥å‡é“¶è¡Œæµæ°´ï¼Œå…ˆç”¨å¤šçº¿ç¨‹å¤„ç†æ¯ä¸ª sheet é‡Œçš„é“¶è¡Œæµæ°´ï¼Œéƒ½æ‰§è¡Œå®Œä¹‹åï¼Œå¾—åˆ°æ¯ä¸ª sheet çš„æ—¥å‡é“¶è¡Œæµæ°´ï¼Œæœ€åï¼Œå†ç”¨ barrierAction ç”¨è¿™äº›çº¿ç¨‹çš„è®¡ç®—ç»“æœï¼Œè®¡ç®—å‡ºæ•´ä¸ª Excel çš„æ—¥å‡é“¶è¡Œæµæ°´ã€‚</p><h3 id="cyclicbarrier-çš„ä½¿ç”¨ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#cyclicbarrier-çš„ä½¿ç”¨ç¤ºä¾‹" aria-hidden="true">#</a> CyclicBarrier çš„ä½¿ç”¨ç¤ºä¾‹</h3><p>ç¤ºä¾‹ 1ï¼š</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 *
 * <span class="token keyword">@author</span> Snailclimb
 * <span class="token keyword">@date</span> 2018å¹´10æœˆ1æ—¥
 * @Description: æµ‹è¯• CyclicBarrier ç±»ä¸­å¸¦å‚æ•°çš„ await() æ–¹æ³•
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CyclicBarrierExample2</span> <span class="token punctuation">{</span>
  <span class="token comment">// è¯·æ±‚çš„æ•°é‡</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> threadCount <span class="token operator">=</span> <span class="token number">550</span><span class="token punctuation">;</span>
  <span class="token comment">// éœ€è¦åŒæ­¥çš„çº¿ç¨‹æ•°é‡</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">CyclicBarrier</span> cyclicBarrier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CyclicBarrier</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ›å»ºçº¿ç¨‹æ± </span>
    <span class="token class-name">ExecutorService</span> threadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> threadCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">final</span> <span class="token keyword">int</span> threadNum <span class="token operator">=</span> i<span class="token punctuation">;</span>
      <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token function">test</span><span class="token punctuation">(</span>threadNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// TODO Auto-generated catch block</span>
          e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BrokenBarrierException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// TODO Auto-generated catch block</span>
          e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    threadPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">int</span> threadnum<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">BrokenBarrierException</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;threadnum:&quot;</span> <span class="token operator">+</span> threadnum <span class="token operator">+</span> <span class="token string">&quot;is ready&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token doc-comment comment">/**ç­‰å¾…60ç§’ï¼Œä¿è¯å­çº¿ç¨‹å®Œå…¨æ‰§è¡Œç»“æŸ*/</span>
      cyclicBarrier<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;-----CyclicBarrierException------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;threadnum:&quot;</span> <span class="token operator">+</span> threadnum <span class="token operator">+</span> <span class="token string">&quot;is finish&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p>è¿è¡Œç»“æœï¼Œå¦‚ä¸‹ï¼š</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>threadnum:0is ready
threadnum:1is ready
threadnum:2is ready
threadnum:3is ready
threadnum:4is ready
threadnum:4is finish
threadnum:0is finish
threadnum:1is finish
threadnum:2is finish
threadnum:3is finish
threadnum:5is ready
threadnum:6is ready
threadnum:7is ready
threadnum:8is ready
threadnum:9is ready
threadnum:9is finish
threadnum:5is finish
threadnum:8is finish
threadnum:7is finish
threadnum:6is finish
......
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>å¯ä»¥çœ‹åˆ°å½“çº¿ç¨‹æ•°é‡ä¹Ÿå°±æ˜¯è¯·æ±‚æ•°é‡è¾¾åˆ°æˆ‘ä»¬å®šä¹‰çš„ 5 ä¸ªçš„æ—¶å€™ï¼Œ <code>await()</code> æ–¹æ³•ä¹‹åçš„æ–¹æ³•æ‰è¢«æ‰§è¡Œã€‚</p><p>å¦å¤–ï¼Œ<code>CyclicBarrier</code> è¿˜æä¾›ä¸€ä¸ªæ›´é«˜çº§çš„æ„é€ å‡½æ•° <code>CyclicBarrier(int parties, Runnable barrierAction)</code>ï¼Œç”¨äºåœ¨çº¿ç¨‹åˆ°è¾¾å±éšœæ—¶ï¼Œä¼˜å…ˆæ‰§è¡Œ <code>barrierAction</code>ï¼Œæ–¹ä¾¿å¤„ç†æ›´å¤æ‚çš„ä¸šåŠ¡åœºæ™¯ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 *
 * <span class="token keyword">@author</span> SnailClimb
 * <span class="token keyword">@date</span> 2018å¹´10æœˆ1æ—¥
 * @Description: æ–°å»º CyclicBarrier çš„æ—¶å€™æŒ‡å®šä¸€ä¸ª Runnable
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CyclicBarrierExample3</span> <span class="token punctuation">{</span>
  <span class="token comment">// è¯·æ±‚çš„æ•°é‡</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> threadCount <span class="token operator">=</span> <span class="token number">550</span><span class="token punctuation">;</span>
  <span class="token comment">// éœ€è¦åŒæ­¥çš„çº¿ç¨‹æ•°é‡</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">CyclicBarrier</span> cyclicBarrier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CyclicBarrier</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;------å½“çº¿ç¨‹æ•°è¾¾åˆ°ä¹‹åï¼Œä¼˜å…ˆæ‰§è¡Œ------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ›å»ºçº¿ç¨‹æ± </span>
    <span class="token class-name">ExecutorService</span> threadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> threadCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">final</span> <span class="token keyword">int</span> threadNum <span class="token operator">=</span> i<span class="token punctuation">;</span>
      <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token function">test</span><span class="token punctuation">(</span>threadNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// TODO Auto-generated catch block</span>
          e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BrokenBarrierException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// TODO Auto-generated catch block</span>
          e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    threadPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">int</span> threadnum<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">BrokenBarrierException</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;threadnum:&quot;</span> <span class="token operator">+</span> threadnum <span class="token operator">+</span> <span class="token string">&quot;is ready&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cyclicBarrier<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;threadnum:&quot;</span> <span class="token operator">+</span> threadnum <span class="token operator">+</span> <span class="token string">&quot;is finish&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>è¿è¡Œç»“æœï¼Œå¦‚ä¸‹ï¼š</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>threadnum:0is ready
threadnum:1is ready
threadnum:2is ready
threadnum:3is ready
threadnum:4is ready
------å½“çº¿ç¨‹æ•°è¾¾åˆ°ä¹‹åï¼Œä¼˜å…ˆæ‰§è¡Œ------
threadnum:4is finish
threadnum:0is finish
threadnum:2is finish
threadnum:1is finish
threadnum:3is finish
threadnum:5is ready
threadnum:6is ready
threadnum:7is ready
threadnum:8is ready
threadnum:9is ready
------å½“çº¿ç¨‹æ•°è¾¾åˆ°ä¹‹åï¼Œä¼˜å…ˆæ‰§è¡Œ------
threadnum:9is finish
threadnum:5is finish
threadnum:6is finish
threadnum:8is finish
threadnum:7is finish
......
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="cyclicbarrier-æºç åˆ†æ" tabindex="-1"><a class="header-anchor" href="#cyclicbarrier-æºç åˆ†æ" aria-hidden="true">#</a> CyclicBarrier æºç åˆ†æ</h3><p>å½“è°ƒç”¨ <code>CyclicBarrier</code> å¯¹è±¡è°ƒç”¨ <code>await()</code> æ–¹æ³•æ—¶ï¼Œå®é™…ä¸Šè°ƒç”¨çš„æ˜¯ <code>dowait(false, 0L)</code>æ–¹æ³•ã€‚ <code>await()</code> æ–¹æ³•å°±åƒæ ‘ç«‹èµ·ä¸€ä¸ªæ …æ çš„è¡Œä¸ºä¸€æ ·ï¼Œå°†çº¿ç¨‹æŒ¡ä½äº†ï¼Œå½“æ‹¦ä½çš„çº¿ç¨‹æ•°é‡è¾¾åˆ° <code>parties</code> çš„å€¼æ—¶ï¼Œæ …æ æ‰ä¼šæ‰“å¼€ï¼Œçº¿ç¨‹æ‰å¾—ä»¥é€šè¿‡æ‰§è¡Œã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">BrokenBarrierException</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    	<span class="token keyword">return</span> <span class="token function">dowait</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TimeoutException</span> toe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   	 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>toe<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// cannot happen</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><code>dowait(false, 0L)</code>ï¼š</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">// å½“çº¿ç¨‹æ•°é‡æˆ–è€…è¯·æ±‚æ•°é‡è¾¾åˆ° count æ—¶ await ä¹‹åçš„æ–¹æ³•æ‰ä¼šè¢«æ‰§è¡Œã€‚ä¸Šé¢çš„ç¤ºä¾‹ä¸­ count çš„å€¼å°±ä¸º 5ã€‚</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> count<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * Main barrier code, covering the various policies.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">dowait</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> timed<span class="token punctuation">,</span> <span class="token keyword">long</span> nanos<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">BrokenBarrierException</span><span class="token punctuation">,</span>
               <span class="token class-name">TimeoutException</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
        <span class="token comment">// é”ä½</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">Generation</span> g <span class="token operator">=</span> generation<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>g<span class="token punctuation">.</span>broken<span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BrokenBarrierException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// å¦‚æœçº¿ç¨‹ä¸­æ–­äº†ï¼ŒæŠ›å‡ºå¼‚å¸¸</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">breakBarrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// coutå‡1</span>
            <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token operator">--</span>count<span class="token punctuation">;</span>
            <span class="token comment">// å½“ count æ•°é‡å‡ä¸º 0 ä¹‹åè¯´æ˜æœ€åä¸€ä¸ªçº¿ç¨‹å·²ç»åˆ°è¾¾æ …æ äº†ï¼Œä¹Ÿå°±æ˜¯è¾¾åˆ°äº†å¯ä»¥æ‰§è¡Œawait æ–¹æ³•ä¹‹åçš„æ¡ä»¶</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// tripped</span>
                <span class="token keyword">boolean</span> ranAction <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> <span class="token class-name">Runnable</span> command <span class="token operator">=</span> barrierCommand<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>command <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                        command<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    ranAction <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token comment">// å°† count é‡ç½®ä¸º parties å±æ€§çš„åˆå§‹åŒ–å€¼</span>
                    <span class="token comment">// å”¤é†’ä¹‹å‰ç­‰å¾…çš„çº¿ç¨‹</span>
                    <span class="token comment">// ä¸‹ä¸€æ³¢æ‰§è¡Œå¼€å§‹</span>
                    <span class="token function">nextGeneration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ranAction<span class="token punctuation">)</span>
                        <span class="token function">breakBarrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// loop until tripped, broken, interrupted, or timed out</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timed<span class="token punctuation">)</span>
                        trip<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nanos <span class="token operator">&gt;</span> <span class="token number">0L</span><span class="token punctuation">)</span>
                        nanos <span class="token operator">=</span> trip<span class="token punctuation">.</span><span class="token function">awaitNanos</span><span class="token punctuation">(</span>nanos<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>g <span class="token operator">==</span> generation <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span> g<span class="token punctuation">.</span>broken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">breakBarrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">throw</span> ie<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment">// We&#39;re about to finish waiting even if we had not</span>
                        <span class="token comment">// been interrupted, so this interrupt is deemed to</span>
                        <span class="token comment">// &quot;belong&quot; to subsequent execution.</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>g<span class="token punctuation">.</span>broken<span class="token punctuation">)</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BrokenBarrierException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>g <span class="token operator">!=</span> generation<span class="token punctuation">)</span>
                    <span class="token keyword">return</span> index<span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>timed <span class="token operator">&amp;&amp;</span> nanos <span class="token operator">&lt;=</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">breakBarrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br></div></div><p>æ€»ç»“ï¼š<code>CyclicBarrier</code> å†…éƒ¨é€šè¿‡ä¸€ä¸ª count å˜é‡ä½œä¸ºè®¡æ•°å™¨ï¼Œcount çš„åˆå§‹å€¼ä¸º parties å±æ€§çš„åˆå§‹åŒ–å€¼ï¼Œæ¯å½“ä¸€ä¸ªçº¿ç¨‹åˆ°äº†æ …æ è¿™é‡Œäº†ï¼Œé‚£ä¹ˆå°±å°†è®¡æ•°å™¨å‡ä¸€ã€‚å¦‚æœ count å€¼ä¸º 0 äº†ï¼Œè¡¨ç¤ºè¿™æ˜¯è¿™ä¸€ä»£æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾æ …æ ï¼Œå°±å°è¯•æ‰§è¡Œæˆ‘ä»¬æ„é€ æ–¹æ³•ä¸­è¾“å…¥çš„ä»»åŠ¡ã€‚</p><h3 id="cyclicbarrier-å’Œ-countdownlatch-çš„åŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#cyclicbarrier-å’Œ-countdownlatch-çš„åŒºåˆ«" aria-hidden="true">#</a> CyclicBarrier å’Œ CountDownLatch çš„åŒºåˆ«</h3><p>ä¸‹é¢è¿™ä¸ªæ˜¯å›½å¤–ä¸€ä¸ªå¤§ä½¬çš„å›ç­”ï¼š</p><p><code>CountDownLatch</code> æ˜¯è®¡æ•°å™¨ï¼Œåªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼Œè€Œ <code>CyclicBarrier</code> çš„è®¡æ•°å™¨æä¾› <code>reset</code> åŠŸèƒ½ï¼Œå¯ä»¥å¤šæ¬¡ä½¿ç”¨ã€‚ä½†æ˜¯æˆ‘ä¸é‚£ä¹ˆè®¤ä¸ºå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«ä»…ä»…å°±æ˜¯è¿™ä¹ˆç®€å•çš„ä¸€ç‚¹ã€‚æˆ‘ä»¬æ¥ä» jdk ä½œè€…è®¾è®¡çš„ç›®çš„æ¥çœ‹ï¼Œjavadoc æ˜¯è¿™ä¹ˆæè¿°å®ƒä»¬çš„ï¼š</p><blockquote><p>CountDownLatch: A synchronization aid that allows one or more threads to wait until a set of operations being performed in other threads completes.(CountDownLatch: ä¸€ä¸ªæˆ–è€…å¤šä¸ªçº¿ç¨‹ï¼Œç­‰å¾…å…¶ä»–å¤šä¸ªçº¿ç¨‹å®ŒæˆæŸä»¶äº‹æƒ…ä¹‹åæ‰èƒ½æ‰§è¡Œï¼›) CyclicBarrier : A synchronization aid that allows a set of threads to all wait for each other to reach a common barrier point.(CyclicBarrier : å¤šä¸ªçº¿ç¨‹äº’ç›¸ç­‰å¾…ï¼Œç›´åˆ°åˆ°è¾¾åŒä¸€ä¸ªåŒæ­¥ç‚¹ï¼Œå†ç»§ç»­ä¸€èµ·æ‰§è¡Œã€‚)</p></blockquote><p>å¯¹äº <code>CountDownLatch</code> æ¥è¯´ï¼Œé‡ç‚¹æ˜¯â€œä¸€ä¸ªçº¿ç¨‹ï¼ˆå¤šä¸ªçº¿ç¨‹ï¼‰ç­‰å¾…â€ï¼Œè€Œå…¶ä»–çš„ N ä¸ªçº¿ç¨‹åœ¨å®Œæˆâ€œæŸä»¶äº‹æƒ…â€ä¹‹åï¼Œå¯ä»¥ç»ˆæ­¢ï¼Œä¹Ÿå¯ä»¥ç­‰å¾…ã€‚è€Œå¯¹äº <code>CyclicBarrier</code>ï¼Œé‡ç‚¹æ˜¯å¤šä¸ªçº¿ç¨‹ï¼Œåœ¨ä»»æ„ä¸€ä¸ªçº¿ç¨‹æ²¡æœ‰å®Œæˆï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½å¿…é¡»ç­‰å¾…ã€‚</p><p><code>CountDownLatch</code> æ˜¯è®¡æ•°å™¨ï¼Œçº¿ç¨‹å®Œæˆä¸€ä¸ªè®°å½•ä¸€ä¸ªï¼Œåªä¸è¿‡è®¡æ•°ä¸æ˜¯é€’å¢è€Œæ˜¯é€’å‡ï¼Œè€Œ <code>CyclicBarrier</code> æ›´åƒæ˜¯ä¸€ä¸ªé˜€é—¨ï¼Œéœ€è¦æ‰€æœ‰çº¿ç¨‹éƒ½åˆ°è¾¾ï¼Œé˜€é—¨æ‰èƒ½æ‰“å¼€ï¼Œç„¶åç»§ç»­æ‰§è¡Œã€‚</p><h3 id="reentrantlock-å’Œ-reentrantreadwritelock" tabindex="-1"><a class="header-anchor" href="#reentrantlock-å’Œ-reentrantreadwritelock" aria-hidden="true">#</a> ReentrantLock å’Œ ReentrantReadWriteLock</h3><p><code>ReentrantLock</code> å’Œ <code>synchronized</code> çš„åŒºåˆ«åœ¨ä¸Šé¢å·²ç»è®²è¿‡äº†è¿™é‡Œå°±ä¸å¤šåšè®²è§£ã€‚å¦å¤–ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼šè¯»å†™é” <code>ReentrantReadWriteLock</code> å¯ä»¥ä¿è¯å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è¯»ï¼Œæ‰€ä»¥åœ¨è¯»æ“ä½œè¿œå¤§äºå†™æ“ä½œçš„æ—¶å€™ï¼Œè¯»å†™é”å°±éå¸¸æœ‰ç”¨äº†ã€‚</p><!--]--></div><!----><footer class="page-meta"><!----><div class="meta-item update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><span class="info">2022/4/3 00:39:30</span></div><div class="meta-item contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: zisgood@gitee.com">zisgood</span><!--]--><!--]--></div></footer><nav class="page-nav"><a href="/posts/java/concurrent/java-concurrent-collections.html" class="nav-link prev" arialabel="Java å¸¸è§å¹¶å‘å®¹å™¨æ€»ç»“"><div class="hint"><span class="arrow left"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->Java å¸¸è§å¹¶å‘å®¹å™¨æ€»ç»“</div></a><a href="/posts/java/concurrent/reentrantlock.html" class="nav-link next" arialabel="ä»ReentrantLockçš„å®ç°çœ‹AQSçš„åŸç†åŠåº”ç”¨"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow right"></span></div><div class="link">ä»ReentrantLockçš„å®ç°çœ‹AQSçš„åŸç†åŠåº”ç”¨<!----></div></a></nav><!----><!----></main><!--]--><!----></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app.2fa2f6d2.js" defer></script>
  </body>
</html>
